<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        .slide-up {
            animation: slideUp 0.6s ease-out;
        }
        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .tab-button.active {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #7f1d1d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #fef2f2, #fce7e7);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg fade-in">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://img2.pic.in.th/pic/logo-HDR.md.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="h-16 w-16 bounce-in">
                    <div class="slide-up">
                        <h1 class="text-3xl md:text-4xl font-bold text-red-800">üìö ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                        <p class="text-lg text-red-600 mt-1">üè´ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏≤‡∏á‡∏î‡∏á‡∏£‡∏±‡∏ê‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-wrap justify-center space-x-2 mb-8 slide-up">
            <button onclick="showTab('form')" id="tab-form" class="tab-button px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-white text-red-700 hover:bg-red-50 active">
                üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏á‡∏≤‡∏ô
            </button>
            <button onclick="showTab('search')" id="tab-search" class="tab-button px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-white text-red-700 hover:bg-red-50">
                üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </button>
            <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-white text-red-700 hover:bg-red-50">
                üìä ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </button>
        </div>

        <!-- Tab Content -->
        <div id="content-form" class="tab-content">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover fade-in">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-red-800 mb-4">üìã ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        <p class="text-gray-600 mb-6">‚úâÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô Google Form ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                        <a href="https://forms.gle/KswLMfmwWqhM4PJ5A" target="_blank" 
                           class="inline-block bg-gradient-to-r from-red-400 to-red-600 text-white px-8 py-4 rounded-full font-semibold text-lg hover:from-red-500 hover:to-red-700 transform hover:scale-105 transition-all duration-300 shadow-lg">
                            üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-search" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8 fade-in">
                <h2 class="text-2xl font-bold text-red-800 mb-6">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                
                <!-- Search Form -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="date" id="search-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</label>
                        <input type="date" id="search-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</label>
                        <input type="text" id="search-teacher" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìö ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                        <select id="search-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üèÜ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</label>
                        <select id="search-award" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üéØ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
                        <select id="search-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‚≠ê ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
                        <select id="search-level" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                        </select>
                    </div>
                </div>

                <div class="text-center mb-6">
                    <button onclick="searchData()" class="bg-gradient-to-r from-red-400 to-red-600 text-white px-8 py-3 rounded-full font-semibold hover:from-red-500 hover:to-red-700 transform hover:scale-105 transition-all duration-300 shadow-lg">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>

                <!-- Results Table -->
                <div id="search-results" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-lg overflow-hidden shadow-lg">
                            <thead class="bg-gradient-to-r from-red-400 to-red-600 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left">üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th>
                                    <th class="px-4 py-3 text-left">üèÜ ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</th>
                                    <th class="px-4 py-3 text-left">ü•á ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</th>
                                    <th class="px-4 py-3 text-center">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                </tr>
                            </thead>
                            <tbody id="search-table-body">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 text-center">
                        <p id="search-summary" class="text-lg font-semibold text-red-800"></p>
                    </div>
                    <!-- New Download CSV Button -->
                    <div id="download-csv-container" class="mt-6 hidden text-center">
                         <button onclick="downloadCSV()" class="bg-green-500 text-white px-8 py-3 rounded-full font-semibold hover:bg-green-600 transform hover:scale-105 transition-all duration-300 shadow-lg">
                            ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-dashboard" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8 fade-in">
                <h2 class="text-2xl font-bold text-red-800 mb-6">üìä ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π</h2>
                
                <!-- Date Filter -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="date" id="dashboard-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</label>
                        <input type="date" id="dashboard-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent">
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadDashboard()" class="w-full bg-gradient-to-r from-red-400 to-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-red-500 hover:to-red-700 transform hover:scale-105 transition-all duration-300">
                            üìà ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏£‡∏≤‡∏ü
                        </button>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 rounded-xl p-6 card-hover">
                        <h3 class="text-xl font-bold text-red-800 mb-4 text-center">üìö ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h3>
                        <div class="h-80">
                            <canvas id="subjectChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 card-hover">
                        <h3 class="text-xl font-bold text-red-800 mb-4 text-center">üèÜ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</h3>
                        <div class="h-80">
                            <canvas id="awardChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 card-hover">
                        <h3 class="text-xl font-bold text-red-800 mb-4 text-center">üéØ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
                        <div class="h-80">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 card-hover">
                        <h3 class="text-xl font-bold text-red-800 mb-4 text-center">‚≠ê ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
                        <div class="h-80">
                            <canvas id="levelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-red-800">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-red-600 text-2xl">‚úï</button>
                </div>
                <div id="modal-content" class="space-y-4">
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-red-800 text-white py-6 mt-12 fade-in">
        <div class="container mx-auto px-4 text-center">
            <p class="text-lg">üè´ ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏≤‡∏á‡∏î‡∏á‡∏£‡∏±‡∏ê‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå</p>
        </div>
    </footer>

    <script>
        // API URL from Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbzGvpBUr_IscZsT4YiS28EhNU86wJ0jceUdd6O-G3C_D5XwoASRhIehWUHJZWUU_rz6/exec';
        let allData = [];
        let lastFilteredData = []; // Global variable to store the last search results

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Load data if needed
            if (tabName === 'search' || tabName === 'dashboard') {
                loadData();
            }
        }

        // Load data from Google Sheets
        async function loadData() {
            try {
                // Fetch data from the Google Apps Script URL
                const response = await fetch(API_URL);
                const data = await response.json();
                allData = data;
                populateFilters();
                // Check if the dashboard tab is visible and load it
                if (document.getElementById('content-dashboard').classList.contains('hidden') === false) {
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Use a modal or a div to display an error message, instead of alert()
                const errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                showErrorModal(errorMessage);
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Get unique values for each filter from the data
            const subjects = [...new Set(allData.map(row => row[4]).filter(Boolean))];
            const awards = [...new Set(allData.map(row => row[6]).filter(Boolean))];
            const types = [...new Set(allData.map(row => row[9]).filter(Boolean))];
            const levels = [...new Set(allData.map(row => row[10]).filter(Boolean))];

            populateSelect('search-subject', subjects);
            populateSelect('search-award', awards);
            populateSelect('search-type', types);
            populateSelect('search-level', levels);
        }

        function populateSelect(elementId, options) {
            const select = document.getElementById(elementId);
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Search functionality
        function searchData() {
            // Get filter values from input fields
            const startDate = document.getElementById('search-start-date').value;
            const endDate = document.getElementById('search-end-date').value;
            const teacher = document.getElementById('search-teacher').value.toLowerCase();
            const subject = document.getElementById('search-subject').value;
            const award = document.getElementById('search-award').value;
            const type = document.getElementById('search-type').value;
            const level = document.getElementById('search-level').value;

            let filteredData = allData.filter(row => {
                // Skip header row
                if (row[0] === '‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤') return false;

                // Date filter
                if (startDate || endDate) {
                    const rowDate = parseDate(row[11]);
                    if (rowDate) {
                        if (startDate && rowDate < new Date(startDate)) return false;
                        if (endDate && rowDate > new Date(endDate)) return false;
                    }
                }

                // Other filters
                if (teacher && !row[2].toLowerCase().includes(teacher)) return false;
                if (subject && row[4] !== subject) return false;
                if (award && row[6] !== award) return false;
                if (type && row[9] !== type) return false;
                if (level && row[10] !== level) return false;

                return true;
            });
            
            // Store the filtered data in the global variable
            lastFilteredData = filteredData;

            displaySearchResults(filteredData);
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            // Handle various date formats (e.g., DD/MM/YYYY)
            const parts = dateString.split('/');
            if (parts.length === 3) {
                // new Date(year, monthIndex, day)
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateString);
        }

        function displaySearchResults(data) {
            const tbody = document.getElementById('search-table-body');
            const summary = document.getElementById('search-summary');
            const resultsDiv = document.getElementById('search-results');
            const downloadButtonContainer = document.getElementById('download-csv-container');

            tbody.innerHTML = '';
            
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-red-50 transition-colors duration-200';
                tr.innerHTML = `
                    <td class="px-4 py-3">${row[2] || '-'}</td>
                    <td class="px-4 py-3">${row[5] || '-'}</td>
                    <td class="px-4 py-3">${row[6] || '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="showDetail(${index})" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                            üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            summary.textContent = `üìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            resultsDiv.classList.remove('hidden');

            // Show or hide the download button based on search results
            if (data.length > 0) {
                downloadButtonContainer.classList.remove('hidden');
            } else {
                downloadButtonContainer.classList.add('hidden');
            }
        }

        function getDriveFileId(url) {
            // Regular expression to find a Google Drive file ID in a URL
            const regex = /[-\w]{25,}/;
            const match = url.match(regex);
            return match ? match[0] : null;
        }

        function createThumbnailHtml(url, altText) {
            const fileId = getDriveFileId(url);
            if (!fileId) {
                return `<span class="text-red-500">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>`;
            }
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}`;
            return `<a href="${url}" target="_blank" class="block w-24 h-24 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300">
                        <img src="${thumbnailUrl}" alt="${altText}" class="w-full h-full object-cover">
                    </a>`;
        }


        function showDetail(index) {
            // Find the correct data row from the last filtered results
            const row = lastFilteredData[index];
            if (!row) return; // Guard against potential errors

            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');

            const fields = [
                '‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå', '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°', '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', 
                '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ', '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô', '‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö', '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
                '‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û1:', '‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û2:', '‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û3:', '‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û4:', 'URL ‡πÑ‡∏ü‡∏•‡πå PDF'
            ];

            let detailsHTML = fields.map((field, i) => {
                let value = row[i] || '-';
                let displayValue = value;

                // Format dates to Thai Buddhist calendar (‡∏û.‡∏®.)
                if (i === 0 || i === 11) {
                    displayValue = formatDateThai(value);
                }

                // Check for image URLs and render thumbnails
                if (i >= 12 && i <= 15 && value !== '-') {
                    displayValue = createThumbnailHtml(value, field);
                }

                // Check for PDF URL field and render a button if a URL exists
                if (i === 16 && value !== '-') {
                    displayValue = `<a href="${value}" target="_blank" class="inline-block bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200">
                                        ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF
                                    </a>`;
                }

                return `<div class="border-b pb-2">
                            <strong class="text-red-800">${field}:</strong> 
                            <span class="ml-2">${displayValue}</span>
                        </div>`;
            }).join('');

            content.innerHTML = detailsHTML;
            modal.classList.remove('hidden');
        }

        // Function to format date to Thai Buddhist calendar
        function formatDateThai(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                // Handle DD/MM/YYYY format
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const d = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10) - 1;
                    const y = parseInt(parts[2], 10);
                    const newDate = new Date(y, m, d);
                    return newDate.toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
                return dateString;
            }

            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return date.toLocaleDateString('th-TH', options);
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // New function to download CSV file
        function downloadCSV() {
            const header = [
                '‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå', '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°', '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', 
                '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ', '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô', '‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö', '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
                '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢', '‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'URL ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠', '‡∏ú‡∏π‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'URL ‡πÑ‡∏ü‡∏•‡πå PDF'
            ];

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                header.join(',') + '\n' + 
                lastFilteredData.map(row => {
                    // Escape commas and newlines in data fields
                    return row.map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(',');
                }).join('\n');

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'student_info.csv');
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
        }

        // Dashboard functionality
        function loadDashboard() {
            const startDate = document.getElementById('dashboard-start-date').value;
            const endDate = document.getElementById('dashboard-end-date').value;

            let filteredData = allData.filter(row => {
                if (row[0] === '‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤') return false;

                if (startDate || endDate) {
                    const rowDate = parseDate(row[11]);
                    if (rowDate) {
                        if (startDate && rowDate < new Date(startDate)) return false;
                        if (endDate && rowDate > new Date(endDate)) return false;
                    }
                }
                return true;
            });

            createCharts(filteredData);
        }

        function createCharts(data) {
            // Vibrant color palette
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#7C4DFF', '#00BCD4'];
            
            // Subject chart
            createDoughnutChart('subjectChart', data, 4, colors);
            
            // Award chart
            createDoughnutChart('awardChart', data, 6, colors);
            
            // Type chart
            createDoughnutChart('typeChart', data, 9, colors);
            
            // Level chart
            createDoughnutChart('levelChart', data, 10, colors);
        }

        function createDoughnutChart(canvasId, data, columnIndex, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy existing chart to prevent re-rendering issues
            if (window[canvasId + 'Instance']) {
                window[canvasId + 'Instance'].destroy();
            }

            const counts = {};
            data.forEach(row => {
                const value = row[columnIndex] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                counts[value] = (counts[value] || 0) + 1;
            });

            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            const labels = Object.keys(counts);
            const values = Object.values(counts);
            const percentages = values.map(v => ((v / total) * 100).toFixed(1));

            window[canvasId + 'Instance'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map((label, i) => `${label} (${values[i]}, ${percentages[i]}%)`),
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.2,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    family: 'Sarabun',
                                    size: 11
                                },
                                boxWidth: 12
                            }
                        }
                    }
                }
            });
        }
        
        // Custom modal to replace alert()
        function showErrorModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
                    <h3 class="text-xl font-bold text-red-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button onclick="this.parentNode.parentNode.remove()" class="bg-red-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-600">
                        ‡∏ï‡∏Å‡∏•‡∏á
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize the app by showing the form tab
        document.addEventListener('DOMContentLoaded', function() {
            showTab('form');
        });
    </script>
</body>
</html>
